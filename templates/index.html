<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Identificaci√≥n de Plantas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            text-align: center;
            padding: 20px;
        }
        h1 { color: #2e7d32; }
        input, button {
            font-size: 1.2rem;
            margin: 10px;
            padding: 10px;
        }
        #map {
            height: 300px;
            width: 90%;
            margin: 20px auto;
            border-radius: 10px;
        }
        .menu button {
            background-color: #4caf50;
            color: white;
            font-size: 1rem;
            padding: 10px;
            border-radius: 10px;
            margin: 5px;
        }
        #progress-container {
            width: 90%;
            background-color: #ddd;
            border-radius: 10px;
            margin: 20px auto;
            display: none;
        }
        #progress-bar {
            width: 0%;
            height: 20px;
            background-color: #4caf50;
            text-align: center;
            color: white;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <h1>Identificaci√≥n de Plantas</h1>
    <input type="text" id="username" placeholder="Ingrese su nombre">
    <div class="menu">
        <button onclick="selectOrgan('leaf')">üåø Hoja</button>
        <button onclick="selectOrgan('fruit')">üçé Fruto</button>
        <button onclick="selectOrgan('stem')">ü™µ Tallo</button>
        <button onclick="selectOrgan('entire')">üå≥ Completo</button>
    </div>
    <button onclick="selectImage()">üì∏ Tomar Foto</button>

    <div id="map"></div>

    <div id="progress-container">
        <div id="progress-bar">0%</div>
    </div>

    <button id="submit-button" disabled>Enviar Datos</button>

    <h2>Registros Recientes</h2>
    <div>
        {% for record in records %}
        <div>
            <strong>{{ record[1] }}</strong> - {{ record[5] }} <br>
            <img src="{{ record[3] }}" alt="Imagen de la planta" width="100">
        </div>
        {% endfor %}
    </div>

    <script>
        let gpsPosition = null;
        let selectedImage = null;
        let selectedOrgan = null;

        const map = L.map('map').setView([2.5, -76.5], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        navigator.geolocation.getCurrentPosition(
            position => {
                gpsPosition = [position.coords.latitude, position.coords.longitude];
                map.setView(gpsPosition, 12);
                L.marker(gpsPosition).addTo(map).bindPopup("Tu ubicaci√≥n").openPopup();
            },
            error => console.error(error)
        );

        function selectOrgan(organ) {
            selectedOrgan = organ;
            alert("√ìrgano seleccionado: " + organ);
        }

        function selectImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = () => {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = () => {
                    selectedImage = reader.result.split(',')[1];
                    document.getElementById('submit-button').disabled = false;
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        document.getElementById('submit-button').addEventListener('click', () => {
            const username = document.getElementById('username').value;
            if (!username || !selectedImage || !selectedOrgan || !gpsPosition) {
                alert("Complete todos los campos.");
                return;
            }

            document.getElementById('progress-container').style.display = 'block';
            let progress = 0;
            const progressBar = document.getElementById('progress-bar');
            const interval = setInterval(() => {
                progress += 10;
                progressBar.style.width = progress + "%";
                progressBar.textContent = progress + "%";
                if (progress >= 100) clearInterval(interval);
            }, 300);

            fetch('/upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, organ: selectedOrgan, image: selectedImage, location: gpsPosition.join(", ") })
            }).then(response => response.json())
            .then(data => alert(`Planta identificada: ${data.scientific_name}`))
            .catch(error => alert("Error en el registro."));
        });
    </script>
</body>
</html>
